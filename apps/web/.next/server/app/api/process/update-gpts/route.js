"use strict";(()=>{var t={};t.id=631,t.ids=[631],t.modules={517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:t=>{t.exports=require("buffer")},6113:t=>{t.exports=require("crypto")},2361:t=>{t.exports=require("events")},7147:t=>{t.exports=require("fs")},3685:t=>{t.exports=require("http")},5687:t=>{t.exports=require("https")},1808:t=>{t.exports=require("net")},2037:t=>{t.exports=require("os")},1017:t=>{t.exports=require("path")},2781:t=>{t.exports=require("stream")},4404:t=>{t.exports=require("tls")},7310:t=>{t.exports=require("url")},9796:t=>{t.exports=require("zlib")},3551:(t,e,r)=>{r.r(e),r.d(e,{headerHooks:()=>_,originalPathname:()=>f,patchFetch:()=>m,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>c,staticGenerationBailout:()=>h});var a={};r.r(a),r.d(a,{POST:()=>d});var i=r(7596),o=r(3419),n=r(4705),s=r(2858),u=r(6954);async function d(){try{let t=await (0,s.r2)(),e=await (0,u.cM)(),r=e.length;console.log(`all gpts count: ${r}, exist gpts count: ${t.length}`);let a=0,i=0,o=0;for(let n=0;n<r;n++){let u=e[n];if(u.uuid){if(t&&t.includes(u.uuid)){console.log("gpt exist: ",u.uuid,u.name),a+=1;continue}try{await (0,s.iz)(u),i+=1,console.log("insert new gpts: ",u.uuid,u.name,n,r-n)}catch(t){o+=1,console.log("insert gpts failed: ",u.uuid,u.name,n,t)}}}return Response.json({data:{all_count:r,exist_count:a,new_count:i,failed_count:o}})}catch(t){return console.log("update gpts failed: ",t),Response.json({error:t})}}let p=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/process/update-gpts/route",pathname:"/api/process/update-gpts",filename:"route",bundlePath:"app/api/process/update-gpts/route"},resolvedPagePath:"/Users/hzy/Code/chatgptThing/madan/app/OpenGPTS/my-turborepo/apps/web/src/app/api/process/update-gpts/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:c,serverHooks:g,headerHooks:_,staticGenerationBailout:h}=p,f="/api/process/update-gpts/route";function m(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:c})}},2858:(t,e,r)=>{r.d(e,{FX:()=>l,NV:()=>c,Rp:()=>d,iz:()=>o,r2:()=>n,u4:()=>s,uo:()=>p,yv:()=>u});var a=r(831),i=r(6954);async function o(t){return await a.i6`INSERT INTO gpts 
    (uuid, org_id, name, description, avatar_url, short_url, author_id, author_name, created_at, updated_at, detail) 
    VALUES 
    (${t.uuid}, ${t.org_id}, ${t.name}, ${t.description}, ${t.avatar_url}, ${t.short_url}, ${t.author_id}, ${t.author_name}, ${t.created_at}, ${t.updated_at}, ${t.detail})
`}async function n(){let t=await a.i6`SELECT uuid FROM gpts`;if(0===t.rowCount)return[];let{rows:e}=t,r=[];return e.forEach(t=>{r.push(t.uuid)}),r}async function s(t){let e=`%${t}%`;return g(await a.i6`SELECT * FROM gpts WHERE name ILIKE ${e} ORDER BY sort DESC LIMIT 50`)}async function u(t,e){return g(await a.i6`SELECT * FROM gpts WHERE id > ${t} ORDER BY RANDOM() LIMIT ${e}`)}async function d(t,e){return g(await a.i6`SELECT * FROM gpts WHERE id > ${t} ORDER BY created_at DESC LIMIT ${e}`)}async function p(t,e){return g(await a.i6`SELECT * FROM gpts WHERE is_recommended=true AND id > ${t} ORDER BY sort DESC LIMIT ${e}`)}async function l(){let t=await a.i6`SELECT count(1) as count FROM gpts LIMIT 1`;if(0===t.rowCount)return 0;let{rows:e}=t;return e[0].count}async function c(t){let e=await a.i6`SELECT * FROM gpts WHERE uuid = ${t} LIMIT 1`;if(0===e.rowCount)return;let{rows:r}=e;return _(r[0])}function g(t){if(0===t.rowCount)return[];let e=[],{rows:r}=t;return r.forEach(t=>{let r=_(t);r&&e.push(r)}),e}function _(t){let e={uuid:t.uuid,org_id:t.org_id,name:t.name,description:t.description,avatar_url:t.avatar_url,short_url:t.short_url,author_id:t.author_id,author_name:t.author_name,created_at:t.created_at,updated_at:t.updated_at,visit_url:"https://chat.openai.com/g/"+t.short_url,rating:t.rating};try{e.detail=JSON.parse(JSON.stringify(t.detail))}catch(t){console.log("parse gpts detail failed: ",t)}if(!(0,i.OJ)(e))return e}},6954:(t,e,r)=>{r.d(e,{NF:()=>d,OJ:()=>s,cM:()=>o,d3:()=>u,iK:()=>n,pE:()=>p});var a=r(7147),i=r.n(a);let o=async()=>{try{let t=process.env.GPTS_DATA_FILE;if(!t)return[];let e=i().readFileSync(t,"utf8"),r=JSON.parse(e),a=[];return r.map(t=>{a.push({uuid:t.data.gizmo.id,org_id:t.data.gizmo.organization_id,name:t.data.gizmo.display.name,description:t.data.gizmo.display.description,avatar_url:t.data.gizmo.display.profile_picture_url,short_url:t.data.gizmo.short_url,author_id:t.data.gizmo.author.user_id,author_name:t.data.gizmo.author.display_name,created_at:t.created_at,updated_at:t.data.gizmo.updated_at,detail:JSON.stringify(t)})}),a}catch(t){return console.error("Error loading JSON file:",t),[]}},n=async t=>{let e=`${process.env.INDEX_API_BASE_URI}/gpts/search`;try{let r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.INDEX_API_KEY}`},body:JSON.stringify({question:t})}),a=await r.json();if(a.data)return a.data.filter(t=>!s(t))}catch(t){console.log("request gpts search failed: ",t)}return[]};function s(t){let e=(process.env.SENSITIVE_KEYWORDS||"").split(",");for(let r=0,a=e.length;r<a;r++){let a=e[r].trim();if(t.name&&t.name.includes(a)||t.author_name&&t.author_name.includes(a)||t.description&&t.description.includes(a))return console.log("gpt is sensitive: ",t.uuid,t.name,a),!0}return!1}function u(t){if(t.detail)try{return t.detail.data.gizmo.display.prompt_starters}catch(t){console.log("parse gpts detail failed: ",t)}}function d(t){if(t.detail)try{return t.detail.data.gizmo.display.welcome_message}catch(t){console.log("parse gpts detail failed: ",t)}}function p(t){if(t.detail)try{let e=t.detail,r=[];return e.data.tools.forEach(t=>{r.push(t.type)}),r}catch(t){console.log("parse gpts detail failed: ",t)}}},7596:(t,e,r)=>{t.exports=r(517)}};var e=require("../../../../webpack-runtime.js");e.C(t);var r=t=>e(e.s=t),a=e.X(0,[815,831],()=>r(3551));module.exports=a})();